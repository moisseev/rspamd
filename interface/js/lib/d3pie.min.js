/*!
 * rspamd-D3Pie 1.1.1 (https://github.com/moisseev/rspamd-D3Pie)
 * Copyright (c) 2022, Alexander Moisseev, BSD 2-Clause
 */
function D3Pie(g,t){let h=$.extend(!0,{canvasPadding:5,cornerRadius:3,duration:1250,gradient:{enabled:!0,percentage:100},labels:{inner:{hideWhenLessThanPercentage:4,offset:.15},outer:{collideHeight:13,format:"label",pieDistance:30}},padAngle:.01,pieCenterOffset:{x:0,y:0},size:{canvasHeight:400,canvasWidth:600,pieInnerRadius:"20%",pieOuterRadius:"85%"},title:"",total:{enabled:!1}},t);this.destroy=function(){d3.selectAll("#"+g+" svg, #"+g+"-tooltip").remove()},this.destroy();var e,t=d3.select("#"+g).append("svg").attr("class","d3pie").attr("width",h.size.canvasWidth).attr("height",h.size.canvasHeight);let l=0,b=(""!==h.title&&((e=t.append("svg:text").attr("class","chart-title").attr("x",h.size.canvasWidth/2)).append("tspan").text(h.title+" "),l=e.node().getBBox().height,e.attr("y",l+h.canvasPadding)),t.append("g").attr("transform","translate("+(h.size.canvasWidth/2+h.pieCenterOffset.x)+","+(h.size.canvasHeight/2+l/2+h.pieCenterOffset.y)+")")),v={},A={},{outerRadius:x,innerRadius:y}=(()=>{function t(t,e){var a;return/%/u.test(t)?(a=Math.max(0,Math.min(99,parseInt(t.replace(/[\D]/u,""),10)))/100,Math.floor(e*a)):parseInt(t,10)}var e=h.size.canvasWidth-2*h.canvasPadding,a=h.size.canvasHeight-2*h.canvasPadding-l;let n=Math.min(e,a)/2;return"none"!==h.labels.outer.format&&(e=parseInt(h.labels.outer.pieDistance,10),n>e)&&(n-=e),{outerRadius:a=t(h.size.pieOuterRadius,n),innerRadius:t(h.size.pieInnerRadius,a)}})(),m=x+h.labels.outer.pieDistance,M=d3.line().curve(d3.curveCatmullRomOpen),R=d3.select("body").append("div").attr("id",g+"-tooltip").attr("class","d3pie-tooltip"),r=R.append("span").attr("id",g+"-tooltip-text");function w(t){t.on("mouseover",function(t,e){var a=R.datum().total,n=a?Math.round(100*e.data.value/a):NaN;e.data.value?(R.transition().duration(300).style("opacity",1),r.text(e.data.label+(a?": "+e.data.value+" ("+n+"%)":""))):R.transition().duration(300).style("opacity",0),R.each(function(t){t.height=this.getBoundingClientRect().height})}).on("mouseout",function(){R.transition().duration(300).style("opacity",0)}).on("mousemove",t=>{let{pageX:e,pageY:a}=t;R.style("left",e+"px").style("top",function(t){return a-t.height-2+"px"})})}let z=b.append("g"),P=(w(z),z.append("circle").attr("r",y).style("opacity",0),h.total.enabled&&((e=z.append("text").attr("class","total-text")).append("tspan").attr("class","total-value").style("font-size",.6*y+"px"),e.append("tspan").attr("x","0").attr("dy",.5*y).text(void 0!==h.total.label?h.total.label:"Total")),t.append("defs"));this.data=function(t){let l=$.extend(!0,[],t),s=[],e=l.reduce(function(t,e){return t+(e.value||0)},0),a=(R.datum({total:e}),z.datum({data:{label:void 0!==h.total.label?h.total.label:"Total",value:e}}),h.total.enabled&&z.select(".total-value").text(d3.format(".3~s")(e)),l.unshift({label:"undefined",color:h.gradient.enabled?"steelblue":"#ecf1f5",value:0===e?1:0}),d3.scaleOrdinal(d3.schemeSet1));function n(t,e){return void 0!==t&&void 0!==t.color?t.color:a(e)}function o(t,e,a=e){return d3.arc().innerRadius(e).outerRadius(a).centroid(t)}function c(t){return d3.interpolate(v[t.data.label],t)}function u(t){var e=m-.1;return Math.max(-e,Math.min(e,t))}function r(r,i){A[r.data.label].newAngle=(()=>{var t=u(s[i].y);let e=Math.sqrt(Math.pow(m,2)-Math.pow(t,2)),a=((r.endAngle+r.startAngle)/2>Math.PI&&(e*=-1),Math.PI/2-Math.atan2(-t,e));return a<0&&(a+=2*Math.PI),{startAngle:a,endAngle:a}})();let d=d3.interpolate(A[r.data.label].currentAngle,A[r.data.label].newAngle);return function(t){var e=o(d(t),m),[a,n]=e,l=0<a?{dx:5,textAnchor:"start"}:{dx:-5,textAnchor:"end"};return d3.select(b.selectAll(".link").nodes()[i]).datum([o(c(r)(t),x),o(c(r)(t),x+5),[a,n],[a+l.dx,n]]).attr("d",M),d3.select(b.selectAll(".outer-label").nodes()[i]).attr("dx",l.dx).style("text-anchor",l.textAnchor),"translate("+e+")"}}t=d3.transition().duration(h.duration);function i(t){return t.data.label}h.gradient.enabled&&((p=P.selectAll("radialGradient").data(l,function(t){return t.label}).enter().append("radialGradient").attr("gradientUnits","userSpaceOnUse").attr("cx",0).attr("cy",0).attr("r","120%").attr("id",function(t,e){return g+"-grad"+e})).append("stop").attr("class","grad-stop-0").style("stop-color",n),p.append("stop").attr("class","grad-stop-1").attr("offset",h.gradient.percentage+"%"),P.selectAll("radialGradient").select(".grad-stop-0").transition(t).style("stop-color",n));let d=d3.pie().sort(null).value(function(t){return t.value});var p=b.selectAll(".slice-g").data(d(l),i),f=p.enter().append("g").attr("class","slice-g");w(f),f.append("path").attr("id",function(t,e){return g+"-slice"+e}).attr("class","slice").attr("fill",function(t,e){return h.gradient.enabled?"url(#"+g+"-grad"+e+")":n(t.data,e)}),p.exit().each(function(t,e){l[e]={value:0,label:t.data.label}}),d(l).forEach(function(t,e){void 0===v[t.data.label]&&(e=e?v[d(l)[e-1].data.label].endAngle:0,v[t.data.label]={startAngle:e,endAngle:e})}),b.selectAll(".slice").data(d(l),i).transition(t).attrTween("d",function(e){return function(t){return d3.arc().padAngle(h.padAngle).cornerRadius(h.cornerRadius).innerRadius(y).outerRadius(x)(c(e)(t))}}).end().then(function(){l=l.filter(function(t,e){return 0===e||t.value}),P.selectAll("radialGradient").data(l,function(t){return t.label}).exit().remove(),b.selectAll(".slice-g").data(d(l),i).exit().each(function(t){delete v[t.data.label],delete A[t.data.label]}).remove();for(var t of d(l))v[t.data.label]=t,"none"!==h.labels.outer.format&&(A[t.data.label].currentAngle=A[t.data.label].newAngle);b.selectAll(".slice-g").classed("first-slice",!1);var e=b.select(".slice-g");e.empty()||e.classed("first-slice",!0)}).catch(function(t){console.warn(t)}),f.append("text").attr("class","inner-label").attr("dy",".35em"),b.selectAll(".inner-label").data(d(l),i).text(function(t){return"undefined"===t.data.label?"undefined":Math.round(100*t.data.value/e)+"%"}).transition(t).attrTween("opacity",function(e){return e.data.value?function(t){t=c(e)(t);return 100*(t.endAngle-t.startAngle)/(2*Math.PI)<h.labels.inner.hideWhenLessThanPercentage?0:1}:function(){return 0}}).attrTween("transform",function(e){return function(t){return"translate("+o(c(e)(t),y*(1-h.labels.inner.offset),x*(1+h.labels.inner.offset))+")"}}),"none"!==h.labels.outer.format&&(d(l).forEach(function(t,e){void 0===A[t.data.label]&&(e=e?v[d(l)[e-1].data.label].endAngle:0,A[t.data.label]={currentAngle:{startAngle:e,endAngle:e},newAngle:{startAngle:e,endAngle:e}});let a=0;var[e,n]=o(t,m);t.data.value&&(a=0<=e?h.labels.outer.collideHeight:-h.labels.outer.collideHeight),s.push({fx:a,y:n})}),d3.forceSimulation(s).alphaMin(.5).force("collide",d3.forceCollide(h.labels.outer.collideHeight/2)).force("boundY",function(){for(var t of s)t.y=u(t.y)}).tick(30),(p=f.append("g").attr("class","outer-label-g")).append("text").attr("class","outer-label").attr("dy",".35em").text(i),p.append("path").attr("class","link"),b.selectAll(".outer-label-g").data(d(l),i).transition(t).style("opacity",function(t,e){return e&&t.value?1:0}).each(function(t,e){$(this).children(".link").attr("stroke",n(t.data,e))}),b.selectAll(".outer-label").data(d(l),i).transition(t).attrTween("transform",r))}}